% Patch lineno to make it work with AMS environments
% https://tex.stackexchange.com/a/443201
\makeatletter
\if@review
  \newcommand*\linenomathpatch{\@ifstar{\linenomathpatch@AMS}{\linenomathpatch@}}
  \newcommand*\linenomathpatch@[1]{
    \expandafter\pretocmd\csname #1\endcsname {\linenomathWithnumbers}{}{}
    \expandafter\pretocmd\csname #1*\endcsname{\linenomathWithnumbers}{}{}
    \expandafter\apptocmd\csname end#1\endcsname {\endlinenomath}{}{}
    \expandafter\apptocmd\csname end#1*\endcsname{\endlinenomath}{}{}
  }
  \newcommand*\linenomathpatch@AMS[1]{
    \expandafter\pretocmd\csname #1\endcsname {\linenomathWithnumbersAMS}{}{}
    \expandafter\pretocmd\csname #1*\endcsname{\linenomathWithnumbersAMS}{}{}
    \expandafter\apptocmd\csname end#1\endcsname {\endlinenomath}{}{}
    \expandafter\apptocmd\csname end#1*\endcsname{\endlinenomath}{}{}
  }
  \let\linenomathWithnumbersAMS\linenomathWithnumbers
  \patchcmd\linenomathWithnumbersAMS{\advance\postdisplaypenalty\linenopenalty}{}{}{}
  \linenomathpatch{equation}
  \linenomathpatch*{gather}
  \linenomathpatch*{multline}
  \linenomathpatch*{align}
  \linenomathpatch*{alignat}
  \linenomathpatch*{flalign}
\fi
\makeatother
